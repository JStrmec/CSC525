from typing import Dict
import unittest
import torch
from torch.nn.functional import cosine_similarity
from mental_health_retrieval_chatbot.semantic_encoder import CHAR_TRUNCATION
from mental_health_retrieval_chatbot.semantic_encoder import SemanticEncoder


class TestSemanticEncoder(unittest.TestCase):
    @classmethod
    def setUpClass(cls):
        cls.model = SemanticEncoder()

    def test_query_prefix(self):
        input_text = "This is a query"
        result = self.model.encode(input_dict={"text": input_text, "dataType": "query"})
        self.assertIn("vector", result)
        self.assertIsInstance(result["vector"], list)

    def test_passage_prefix(self):
        input_text = "This is a passage"
        result = self.model.encode(
            input_dict={"text": input_text, "dataType": "passage"}
        )
        self.assertIn("vector", result)
        self.assertIsInstance(result["vector"], list)

    def test_invalid_input(self):
        result = self.model.encode(input_dict={"dataType": "query"})
        self.assertIsInstance(result, Dict)
        self.assertIn("error", result)

    def test_obj_to_bool(self):
        self.assertTrue(self.model.obj_to_bool(True))
        self.assertTrue(self.model.obj_to_bool("True"))
        self.assertTrue(self.model.obj_to_bool(1))
        self.assertFalse(self.model.obj_to_bool("False"))
        self.assertFalse(self.model.obj_to_bool(0))
        self.assertFalse(self.model.obj_to_bool(None))

    def test_validate_and_truncate_text(self):
        # ── None ────────────────────────────────────────────────────────────────
        resp = self.model.validate_and_truncate_text(None)
        self.assertIsInstance(resp, Dict)
        self.assertIn("error", resp)

        # ── Empty string ────────────────────────────────────────────────────────
        resp = self.model.validate_and_truncate_text("")
        self.assertIsInstance(resp, Dict)
        self.assertIn("error", resp)

        # ── Too-long string ─────────────────────────────────────────────────────
        long_text = "a" * (CHAR_TRUNCATION + 10)
        truncated = self.model.validate_and_truncate_text(long_text)
        self.assertIsInstance(truncated, str)
        self.assertEqual(len(truncated), CHAR_TRUNCATION)

        # ── Valid string ────────────────────────────────────────────────────────
        valid_text = "Hello, world!"
        result = self.model.validate_and_truncate_text(valid_text)
        self.assertEqual(result, valid_text)

    def test_encoding_similarity(self):
        # Known text
        input_text = "i love fusion"

        # Predict vector
        result = self.model.encode(input_dict={"text": input_text, "dataType": None})

        self.assertIn("vector", result)
        output_vector = torch.tensor(result["vector"], dtype=torch.float32)

        expected_vec = torch.tensor(
            [
                0.026931763,
                0.043945312,
                -0.005378723,
                0.022109985,
                0.0019016266,
                0.030471802,
                -0.015777588,
                0.0020446777,
                0.023635864,
                -0.017700195,
                -0.009643555,
                0.020004272,
                -0.0047416687,
                2.4974346e-5,
                -0.019104004,
                0.008476257,
                -0.017028809,
                0.012794495,
                -0.03540039,
                -0.01889038,
                -0.073791504,
                0.030273438,
                0.005458832,
                -0.06390381,
                0.016845703,
                0.06738281,
                -0.016616821,
                -0.011558533,
                -0.013076782,
                0.004650116,
                -0.026153564,
                0.06555176,
                -0.010314941,
                -0.022781372,
                -0.058502197,
                -0.040374756,
                0.004627228,
                -0.009155273,
                -0.072753906,
                -0.027709961,
                -0.08984375,
                -0.02432251,
                -0.0027542114,
                -0.0038871765,
                0.021865845,
                -0.011680603,
                -0.088378906,
                -0.015029907,
                -0.03778076,
                0.03161621,
                0.014213562,
                0.04675293,
                -0.058685303,
                0.046813965,
                -0.0680542,
                0.013504028,
                -0.045135498,
                -0.05441284,
                -0.0034980774,
                0.019927979,
                -1.3947487e-5,
                0.0062446594,
                0.06298828,
                -0.054626465,
                -0.08673096,
                0.064819336,
                0.004749298,
                0.038208008,
                -0.030349731,
                -0.015571594,
                0.0061149597,
                0.023223877,
                -0.015113831,
                0.08795166,
                0.0035095215,
                -0.015197754,
                -0.027191162,
                -0.030014038,
                0.034301758,
                0.09448242,
                0.16772461,
                0.012268066,
                0.045043945,
                -0.051361084,
                -0.008728027,
                -0.009208679,
                0.019973755,
                0.022491455,
                0.0149383545,
                0.038604736,
                -0.014350891,
                0.03173828,
                0.03756714,
                0.023620605,
                -0.030853271,
                0.0030174255,
                -0.024917603,
                0.0748291,
                -0.03540039,
                -0.044799805,
                -0.058044434,
                0.059509277,
                -0.023117065,
                -0.0017232895,
                -0.020385742,
                -0.010215759,
                -0.011192322,
                0.011116028,
                -0.03656006,
                -0.042755127,
                0.02822876,
                -0.019943237,
                0.022506714,
                -0.013076782,
                0.026687622,
                -0.031311035,
                0.08856201,
                -0.01763916,
                0.13244629,
                -0.054656982,
                -0.0036678314,
                0.024475098,
                -0.025421143,
                -0.021011353,
                0.024780273,
                -0.062927246,
                0.04385376,
                0.021087646,
                -0.06842041,
                0.05984497,
                0.016815186,
                0.0088272095,
                7.5006485e-4,
                -0.009590149,
                -0.02960205,
                0.026138306,
                0.014427185,
                -0.0085372925,
                -0.024612427,
                -0.013763428,
                -0.002462387,
                0.049987793,
                0.07080078,
                -0.036102295,
                0.04815674,
                -0.03414917,
                0.019577026,
                -0.051696777,
                -0.039733887,
                -0.072387695,
                -0.050842285,
                -0.027023315,
                -0.0446167,
                0.01828003,
                -0.026885986,
                0.009231567,
                0.06384277,
                0.08294678,
                -0.017211914,
                -0.008926392,
                -0.024932861,
                -0.05999756,
                -0.027267456,
                0.0011825562,
                0.036254883,
                0.023529053,
                0.07409668,
                -0.0015420914,
                -0.014122009,
                -0.01965332,
                0.011459351,
                -0.0038261414,
                -0.05581665,
                -0.058807373,
                0.030456543,
                0.07312012,
                0.020050049,
                -0.032165527,
                -0.024841309,
                -0.05166626,
                -0.01071167,
                -0.0023937225,
                0.0031414032,
                -0.013809204,
                0.057006836,
                -0.05508423,
                -0.040496826,
                -0.01272583,
                -0.008148193,
                0.011146545,
                0.040802002,
                -0.060455322,
                0.061431885,
                -0.07495117,
                0.059387207,
                0.034942627,
                0.004283905,
                -0.049987793,
                -0.020004272,
                0.017150879,
                0.04244995,
                -0.007621765,
                0.0345459,
                -0.008361816,
                0.01953125,
                0.019195557,
                -0.03955078,
                -0.021118164,
                -0.074035645,
                0.08526611,
                -0.0018072128,
                -0.03237915,
                -0.08868408,
                -0.07458496,
                0.0036067963,
                0.042297363,
                0.03540039,
                0.059936523,
                0.0077323914,
                -0.025390625,
                -0.03375244,
                0.007472992,
                0.04345703,
                0.018936157,
                -0.009567261,
                -0.0071258545,
                -0.022842407,
                0.050628662,
                -0.09051514,
                0.07775879,
                -0.05001831,
                -0.036621094,
                0.0082092285,
                -0.012939453,
                0.0070343018,
                -0.0056152344,
                0.028656006,
                -0.004711151,
                -0.022064209,
                -0.0022563934,
                -0.04144287,
                0.031555176,
                0.06036377,
                0.058410645,
                -0.03793335,
                -9.34124e-4,
                -0.01335144,
                -0.04321289,
                0.020050049,
                0.01260376,
                -0.006210327,
                0.031677246,
                0.0061302185,
                8.687973e-4,
                0.06121826,
                0.029510498,
                0.01586914,
                -0.010612488,
                -0.006587982,
                -0.018585205,
                -0.008018494,
                0.008995056,
                -0.005607605,
                0.013412476,
                -0.002401352,
                -0.0027866364,
                -0.04321289,
                -0.00541687,
                0.018676758,
                0.02330017,
                0.05508423,
                0.023269653,
                0.027313232,
                0.009407043,
                -0.01638794,
                0.03778076,
                0.012199402,
                -0.017166138,
                0.016418457,
                0.024673462,
                0.052947998,
                -0.00843811,
                0.0087509155,
                -0.022628784,
                0.02897644,
                0.008255005,
                0.01360321,
                0.08905029,
                -0.0035076141,
                -0.016448975,
                0.029830933,
                -0.03982544,
                0.026275635,
                0.011581421,
                0.018310547,
                0.0053138733,
                -0.0023384094,
                -0.0028266907,
                0.021011353,
                0.02432251,
                0.0020771027,
                0.012825012,
                0.03277588,
                -0.03878784,
                0.009529114,
                0.006477356,
                -0.008094788,
                -0.032989502,
                -0.010345459,
                -0.0060539246,
                0.025558472,
                -0.0055351257,
                0.02973938,
                0.019546509,
                -0.02734375,
                -0.006362915,
                -4.9829483e-4,
                -0.05319214,
                -0.01259613,
                0.07727051,
                -0.0049743652,
                0.004589081,
                0.0029525757,
                -0.053771973,
                0.04916382,
                0.04083252,
                -0.037597656,
                -0.011520386,
                0.016647339,
                -0.05581665,
                0.027145386,
                0.024597168,
                0.049438477,
                -0.009841919,
                -0.029678345,
                0.009933472,
                0.013923645,
                0.02166748,
                0.017440796,
                0.0102005005,
                -0.0037212372,
                -0.018630981,
                0.0129776,
                0.056243896,
                -0.00274086,
                -0.006175995,
                -0.030731201,
                -0.0067481995,
                -0.078063965,
                0.0065727234,
                0.022399902,
                -0.019546509,
                0.012367249,
                -0.045043945,
                0.012496948,
                0.04095459,
                -0.018112183,
                0.026153564,
                0.00712204,
                0.028182983,
                0.015640259,
                0.002943039,
                -0.020431519,
                -0.02268982,
                -0.028182983,
                0.038116455,
                -0.03353882,
                0.016342163,
                0.022140503,
                0.008911133,
                0.014312744,
                0.0042648315,
                0.03866577,
                0.01083374,
                -0.005153656,
                -0.032196045,
                -3.335476e-4,
                0.023788452,
                0.0446167,
                -0.02420044,
                -0.014732361,
                0.025421143,
                0.04373169,
                -0.0016365051,
                0.020874023,
                -0.017822266,
                0.034606934,
                0.02406311,
                0.019592285,
                -0.052368164,
                0.038269043,
                0.0340271,
                0.034484863,
                -0.036071777,
                -0.08227539,
                0.0206604,
                0.0042533875,
                -0.002122879,
                0.009613037,
                0.0033931732,
                -0.054138184,
                -0.0039749146,
                0.010528564,
                -0.074523926,
                -0.0015983582,
                -0.021087646,
                0.0029945374,
                -0.04837036,
                0.036315918,
                -0.044067383,
                -0.0072364807,
                0.013412476,
                0.023223877,
                0.06890869,
                -0.021530151,
                0.0010099411,
                0.038330078,
                0.016647339,
                -0.014877319,
                0.035980225,
                0.0024490356,
                0.012680054,
                0.012992859,
                -0.042022705,
                0.010269165,
                0.015037537,
                -0.022949219,
                -0.014015198,
                -0.020614624,
                0.029205322,
                0.016830444,
                0.0068969727,
                -7.9107285e-4,
                -0.037139893,
                -0.017593384,
                -0.029418945,
                0.02027893,
                -0.035461426,
                -0.027740479,
                -0.014381409,
                -0.008522034,
                -0.017745972,
                -0.0309906,
                -0.024276733,
                -0.010818481,
                0.022644043,
                0.014907837,
                0.042816162,
                0.037261963,
                0.014427185,
                -0.025924683,
                0.017532349,
                0.044189453,
                0.030075073,
                -0.01121521,
                9.2601776e-4,
                0.011878967,
                0.026275635,
                -0.026565552,
                0.04046631,
                -0.024459839,
                0.04550171,
                0.06311035,
                0.021148682,
                0.0067329407,
                0.0128479,
                -0.038269043,
                -0.02558899,
                5.636215e-4,
                -1.07347965e-4,
                -0.024795532,
                0.004386902,
                0.008811951,
                -2.989769e-4,
                -6.2561035e-4,
                0.003955841,
                0.0069503784,
                -0.008796692,
                -0.036712646,
                -0.0030326843,
                -0.016204834,
                -0.070007324,
                -0.021255493,
                0.017929077,
                -0.012046814,
                0.030456543,
                0.010597229,
                0.038391113,
                -0.009384155,
                -0.008758545,
                0.035705566,
                -0.0335083,
                0.010025024,
                -0.07574463,
                0.013122559,
                0.024993896,
                0.029144287,
                0.042388916,
                -0.0047340393,
                0.049041748,
                -0.0103302,
                -0.06085205,
                0.026473999,
                -0.02331543,
                0.044128418,
                -0.006198883,
                -0.011405945,
                -0.016921997,
                -0.030349731,
                0.021972656,
                -0.013824463,
                -0.033569336,
                -0.0022735596,
                0.040222168,
                0.0079193115,
                0.0016078949,
                0.0362854,
                -0.049072266,
                0.0017194748,
                0.0017929077,
                0.077819824,
                0.023742676,
                -0.013069153,
                0.022964478,
                -0.0062789917,
                -0.023117065,
                -0.053894043,
                -0.03213501,
                -0.015258789,
                0.0050849915,
                0.021209717,
                0.016036987,
                -0.010032654,
                0.01600647,
                -0.024871826,
                -0.041992188,
                0.007865906,
                -8.072853e-4,
                0.0032920837,
                7.805824e-4,
                5.283356e-4,
                -0.026290894,
                -0.009056091,
                0.009468079,
                -0.03488159,
                -0.0513916,
                0.011421204,
                0.003528595,
                0.043792725,
                0.011253357,
                -0.021484375,
                -0.051757812,
                0.0048828125,
                0.043945312,
                -6.5231323e-4,
                -0.019302368,
                -0.040161133,
                -0.04046631,
                0.010597229,
                0.036315918,
                0.024917603,
                -0.0011177063,
                -0.008934021,
                -0.007129669,
                0.0019311905,
                0.002298355,
                -0.011260986,
                -0.019989014,
                0.034210205,
                -0.006980896,
                -0.0057296753,
                0.0018539429,
                0.008338928,
                -0.0090789795,
                0.008514404,
                -0.00932312,
                0.022888184,
                -0.0042915344,
                0.014701843,
                -0.0149002075,
                0.023742676,
                0.053009033,
                -0.013336182,
                -0.007972717,
                -0.011871338,
                -0.04321289,
                -0.031951904,
                0.035858154,
                -0.043670654,
                -0.057434082,
                0.028533936,
                -0.034301758,
                0.07104492,
                0.027450562,
                -0.0056381226,
                0.008239746,
                -0.009109497,
                -9.3221664e-4,
                0.0069847107,
                -0.014518738,
                -0.006454468,
                -0.042053223,
                0.0059394836,
                6.2704086e-5,
                -0.03375244,
                0.0051841736,
                0.034484863,
                0.015617371,
                -0.015655518,
                0.04144287,
                0.033294678,
                0.0029144287,
                -0.016952515,
                0.02633667,
                -0.015342712,
                0.01940918,
                -0.0034503937,
                -0.013969421,
                -0.02784729,
                -0.0143966675,
                0.058807373,
                0.008506775,
                -0.040100098,
                0.030014038,
                0.0044517517,
                0.0013790131,
                0.024505615,
                0.009567261,
                0.02394104,
                0.0054092407,
                -0.033843994,
                -0.05517578,
                -0.035491943,
                -0.004261017,
                0.04119873,
                8.8214874e-4,
                0.047088623,
                0.03451538,
                0.02406311,
                0.0013332367,
                0.018539429,
                -0.05340576,
                -0.012062073,
                -0.007801056,
                0.011871338,
                -0.029800415,
                -0.005596161,
                -0.024246216,
                0.008277893,
                -0.02758789,
                -0.044799805,
                -0.022384644,
                -0.038146973,
                -0.041503906,
                -0.0020656586,
                -0.027328491,
                -0.009597778,
                -0.0073013306,
                -0.052825928,
                0.030410767,
                0.056152344,
                -0.0057525635,
                0.016418457,
                0.05847168,
                -0.046417236,
                -0.013435364,
                2.79665e-4,
                0.043823242,
                0.022384644,
                -0.02897644,
                0.00137043,
                0.005508423,
                0.019958496,
                0.016906738,
                -0.010856628,
                -0.010276794,
                0.07122803,
                -0.020019531,
                -0.024017334,
                0.02381897,
                -0.024414062,
                -0.057434082,
                0.059387207,
                0.007194519,
                -0.01586914,
                -0.021728516,
                0.01373291,
                0.04360962,
                0.001373291,
                0.0062332153,
                -0.0023269653,
                0.014640808,
                -0.012893677,
                -0.03643799,
                0.083496094,
                0.005657196,
                0.009437561,
                -0.008705139,
                -0.007587433,
                0.038513184,
                -0.0109939575,
                0.011878967,
                0.009223938,
                -0.0017576218,
                -0.01776123,
                -0.015731812,
                0.0061187744,
                -0.0107040405,
                -8.845329e-4,
                0.032073975,
                0.026794434,
                0.026809692,
                -0.008056641,
                -0.03564453,
                -0.021133423,
                0.032165527,
                0.005794525,
                -0.016921997,
                0.010414124,
                0.047912598,
                0.044128418,
                -0.0053977966,
                0.020996094,
                -0.05871582,
                0.00982666,
                0.04296875,
                -0.01638794,
                0.049041748,
                0.050354004,
                0.020965576,
                -2.861023e-4,
                -0.011306763,
                0.005268097,
                0.036895752,
                -8.444786e-4,
                -0.04333496,
                -0.021194458,
                -0.015563965,
                0.026992798,
                -0.032073975,
                -0.017990112,
                -0.03491211,
                0.033966064,
                0.015914917,
                -0.04421997,
                -0.011177063,
                -0.013839722,
                -0.025238037,
                0.0075187683,
                0.0473938,
                -0.037628174,
                -0.015899658,
                0.007633209,
                0.010002136,
                -0.026306152,
                0.012359619,
                0.008171082,
                6.4754486e-4,
                0.047668457,
                0.027511597,
                -0.006839752,
                0.04107666,
                -0.07519531,
                -0.047973633,
                -0.068725586,
                0.005317688,
                -0.0028038025,
                0.0127334595,
                0.014511108,
                0.0015153885,
                0.021133423,
                0.018356323,
                0.024536133,
                0.014854431,
                -0.064331055,
                -0.012176514,
                0.040740967,
                -0.034973145,
                0.0037651062,
                0.036254883,
                -0.017974854,
                0.0128479,
                0.0057411194,
                -0.031280518,
                0.005935669,
                0.018798828,
                -0.017471313,
                -0.008079529,
                0.024780273,
                0.02331543,
                -0.009307861,
                -0.015258789,
                -0.0032367706,
                -0.025054932,
                0.021026611,
                -0.042510986,
                0.032440186,
                -0.052825928,
                0.018188477,
                0.010231018,
                0.00712204,
                -0.012710571,
                0.025772095,
                -0.030548096,
                -0.016937256,
                0.0056877136,
                -0.04144287,
                -0.0012626648,
                -0.02017212,
                0.033294678,
                -0.03137207,
                -0.05380249,
                0.0045318604,
                0.033966064,
                0.004337311,
                0.032196045,
                -1.6343594e-4,
                0.03112793,
                0.033691406,
                0.02935791,
                -0.016647339,
                5.941391e-4,
                -0.018951416,
                0.028121948,
                0.010025024,
                0.030136108,
                -0.003446579,
                0.00894928,
                -0.0078086853,
                -0.014945984,
                0.035827637,
                -0.006542206,
                -0.036071777,
                0.03189087,
                -0.015975952,
                -0.053710938,
                0.019592285,
                -0.042633057,
                0.015960693,
                0.073913574,
                -0.018112183,
                -0.0012245178,
                0.012008667,
                0.0044670105,
                -0.0099487305,
                -0.012863159,
                -0.01474762,
                0.010284424,
                0.024612427,
                0.010765076,
                0.0034923553,
                0.040222168,
                0.008071899,
                -0.003900528,
                -0.028533936,
                -0.016555786,
                0.008796692,
                0.038238525,
                -0.01638794,
                0.002796173,
                -0.02381897,
                0.005924225,
                0.01461792,
                -0.04107666,
                0.017700195,
                -0.014030457,
                -0.035095215,
                0.0063934326,
                -0.019989014,
                0.010169983,
                0.025497437,
                -0.014198303,
                -0.009628296,
                -7.944107e-4,
                -0.013885498,
                0.022720337,
                0.008880615,
                -0.031921387,
                0.007637024,
                0.041534424,
                -0.028961182,
                -0.0010280609,
                -0.04119873,
                -0.023635864,
                0.013931274,
                -0.025909424,
                0.02027893,
                0.004234314,
                -0.01360321,
                0.042541504,
                -0.0043029785,
                0.0026721954,
                -0.030838013,
                -0.022827148,
                0.047729492,
                -0.01033783,
                0.0073890686,
                -0.015266418,
                -0.018341064,
                0.0017623901,
                -0.01864624,
                0.022003174,
                0.035125732,
                0.014480591,
                0.0018596649,
                -6.251335e-4,
                -0.015296936,
                0.027999878,
                -0.036224365,
                -0.035736084,
                -0.010604858,
                -4.7707558e-4,
                0.022918701,
                0.056488037,
                9.813309e-4,
                -0.028182983,
                0.019958496,
                0.010055542,
                0.002544403,
                0.040618896,
                -0.017242432,
                -0.04284668,
                -0.0035953522,
                -0.009590149,
                0.008766174,
                0.014152527,
                -0.04525757,
                -0.031585693,
                -0.057434082,
                0.032409668,
                -0.0047073364,
                0.04309082,
                -0.01197052,
                -0.01876831,
                -0.00819397,
                0.036132812,
                0.049743652,
                8.239746e-4,
                -0.007019043,
                0.0067329407,
                0.04486084,
                0.030914307,
                0.00969696,
                0.022842407,
                -0.012130737,
                -0.05886841,
                0.014350891,
                -0.002521515,
                -0.012924194,
                0.008201599,
                0.012710571,
                0.020202637,
                -0.0039367676,
                4.0841103e-4,
                -0.0037517548,
                -0.047576904,
                0.021484375,
                -0.0029087067,
                -0.049682617,
                -0.008522034,
                0.01651001,
                0.0028629303,
                0.07849121,
                -0.038208008,
                -0.02659607,
                0.013832092,
                0.02659607,
                -0.008804321,
                0.017730713,
                -0.010986328,
                -0.022827148,
                0.0059814453,
                0.037872314,
                0.017059326,
                -0.04071045,
                0.039642334,
                -0.034301758,
                0.013626099,
                -0.0022640228,
                0.019256592,
                -0.024917603,
                0.027359009,
                0.031463623,
                -0.025787354,
                0.018341064,
                -0.01663208,
                -0.05206299,
                -0.0037727356,
                -0.019134521,
                0.06149292,
                0.0038814545,
                0.0041160583,
                -0.011421204,
                -0.0039367676,
                0.011329651,
                -0.0115356445,
                -0.01727295,
                0.015960693,
                0.020599365,
                -0.027679443,
                -0.04360962,
                0.012489319,
                -0.017730713,
                0.045837402,
                0.012893677,
                -0.0077438354,
                -0.02935791,
                -0.005138397,
                -0.038116455,
                -0.026153564,
                0.013092041,
                0.006275177,
                -0.0077590942,
                -0.013046265,
                -0.021484375,
                -0.03552246,
                0.013084412,
                0.016983032,
                -0.018096924,
                -0.031921387,
                -0.055999756,
                0.0063095093,
                -0.008636475,
                0.0158844,
            ],
            dtype=torch.float32,
        )

        sim = cosine_similarity(output_vector, expected_vec, dim=0).item()
        self.assertGreaterEqual(sim, 0.98, f"Cosine similarity too low: {sim}")
